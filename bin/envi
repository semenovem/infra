#!/bin/sh

#
# Утилиты
#

ROOT=$(dirname "$(echo "$0" | grep -E "^/" -q && echo "$0" || echo "$PWD/${0#./}")")
. "${ROOT}/_lib/core.sh" || exit 1

pipe() {
  while read -r data; do
    [ -n "$data" ] && echo "$data"
  done
}

draw_menu() {
  echo "$MENU" | tr ";" "\n" | pipe
}

choice() {
  echo "$MENU" | tr ";" "\n" | pipe | grep -E "^$1"
}

task() {
  echo "$TASK" | grep -E "^$1" -q
}

main() {
  draw_menu
  read -rp ">> Номер задачи. [q для выхода]: " ans

  case "$ans" in
  "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9")
    TASK=$(choice "$ans")
    [ -z "$TASK" ] && return 1
    ;;

  *)
    echo "-- Отмена"
    return 1
    ;;
  esac

  return 0
}

confirm() {
  __confirm__ "Выполнить '$TASK' ? "
  [ $? -ne 0 ] && echo "-- Отмена выполнения задачи" && return 1
  return 0
}

#
#
#

if [ -n "$__HELP__" ]; then
  sh "${ROOT}/utils/envi-sys/help.sh"
  exit 0
fi

sh "${ROOT}/utils/envi-sys/help.sh" -short

#
#
#

# список утилит
MENU="
1. установка
2. обновить repo
3. получить установленную роль
4. установить роль для машины
5. обновить ssh config
6. обновить ssh authorization_keys
7. скомпилировать configuration-app"

TASK=
main || exit 1

task "1." && sh "${ROOT}/utils/envi-sys/install.sh"
task "2." && sh "${ROOT}/utils/envi-sys/update-repo.sh" -force
task "3." && sh "${ROOT}/utils/envi-sys/get-role.sh"
task "4." && sh "${ROOT}/utils/envi-sys/set-role.sh"
task "5." && sh "${ROOT}/_utils/ssh-config-upd.sh" $@
task "6." && sh "${ROOT}/utils/envi-sys/ssh-authorized-keys.sh" $@
task "7." && sh "${ROOT}/../app/configuration/build.sh"
